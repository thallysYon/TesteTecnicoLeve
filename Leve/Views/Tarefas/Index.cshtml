@using System.Security.Claims
@using Leve.Enums
@model Leve.ViewModels.TarefaListaViewModel

@{
    ViewData["Title"] = "Tarefas";
    var isGestor = bool.TryParse(User.FindFirst("IsGestor")?.Value, out var resultado) && resultado;
    var usuarioLogadoId = int.TryParse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out var idLogado) ? idLogado : 0;
}

<div class="uk-section">
    <div class="uk-container">
        <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-bottom">
            <div>
                <h1 class="uk-heading-bullet uk-margin-remove-bottom">Tarefas</h1>
                <p class="uk-text-muted uk-margin-small-top">
                    @(isGestor
                                        ? "Acompanhe as tarefas cadastradas pela sua gestão."
                                        : "Acompanhe suas tarefas pendentes e concluídas.")
                </p>
            </div>

            @if (isGestor)
            {
                <div>
                    <a asp-controller="Tarefas" asp-action="Cadastrar" class="uk-button uk-button-primary">
                        <span uk-icon="plus"></span>
                        <span class="uk-margin-small-left">Nova tarefa</span>
                    </a>
                </div>
            }
        </div>

        @if (TempData["Sucesso"] is not null)
        {
            <div class="uk-alert-success" uk-alert>
                @TempData["Sucesso"]
            </div>
        }

        <div class="uk-margin-bottom uk-text-muted">
            Total de tarefas: <strong>@Model.TotalItens</strong>
        </div>

        @if (!Model.Tarefas.Any())
        {
            <div class="uk-alert-warning" uk-alert>
                Nenhuma tarefa encontrada.
            </div>
        }
        else
        {
            <div class="uk-grid-small uk-child-width-1-1 uk-child-width-1-2@s uk-child-width-1-3@l" uk-grid>
                @foreach (var tarefa in Model.Tarefas)
                {
                    var concluida = tarefa.Status == StatusTarefa.Concluida;
                    var usuarioPodeConcluir = !concluida && tarefa.ResponsavelId == usuarioLogadoId;

                    <div>
                        <div class="uk-card uk-card-default uk-card-body uk-box-shadow-small">
                            <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-bottom">
                                <span class="uk-label @(concluida ? "uk-label-success" : "uk-label-warning")">
                                    @(concluida ? "Concluída" : "Pendente")
                                </span>

                                <span class="uk-text-small uk-text-muted">
                                    @(tarefa.DataLimite?.ToString("dd/MM/yyyy") ?? "Sem data")
                                </span>
                            </div>

                            <p class="uk-margin-small-bottom">
                                <strong>Descrição:</strong><br />
                                @tarefa.Mensagem
                            </p>

                            <p class="uk-margin-small-bottom">
                                <strong>Responsável:</strong><br />
                                @(tarefa.Responsavel?.NomeCompleto ?? "Não informado")
                            </p>

                            <p class="uk-margin-small-bottom">
                                <strong>Gestor criador:</strong><br />
                                @(tarefa.GestorCriador?.NomeCompleto ?? "Não informado")
                            </p>

                            @if (concluida && tarefa.DataConclusao.HasValue)
                            {
                                <p class="uk-margin-small-bottom">
                                    <strong>Concluída em:</strong><br />
                                    @tarefa.DataConclusao.Value.ToString("dd/MM/yyyy HH:mm")
                                </p>
                            }

                            <div class="uk-margin-top uk-grid-small" uk-grid>
                                <div class="uk-width-1-1">
                                    <a asp-controller="Tarefas"
                                       asp-action="Detalhes"
                                       asp-route-id="@tarefa.Id"
                                       class="uk-button uk-button-default uk-width-1-1">
                                        <span uk-icon="search"></span>
                                        <span class="uk-margin-small-left">Ver detalhes</span>
                                    </a>
                                </div>

                                @if (isGestor)
                                {
                                    <div class="uk-width-1-1">
                                        <a asp-controller="Tarefas"
                                           asp-action="Editar"
                                           asp-route-id="@tarefa.Id"
                                           class="uk-button uk-button-primary uk-width-1-1">
                                            <span uk-icon="pencil"></span>
                                            <span class="uk-margin-small-left">Editar</span>
                                        </a>
                                    </div>
                                }

                                @if (usuarioPodeConcluir)
                                {
                                    <div class="uk-width-1-1">
                                        <form asp-action="Concluir" method="post">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@tarefa.Id" />
                                            <button type="submit" class="uk-button uk-button-secondary uk-width-1-1">
                                                <span uk-icon="check"></span>
                                                <span class="uk-margin-small-left">Marcar como concluída</span>
                                            </button>
                                        </form>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (Model.TotalPaginas > 1)
            {
                <div class="uk-margin-large-top uk-flex uk-flex-center">
                    <ul class="uk-pagination">
                        @if (Model.PaginaAtual > 1)
                        {
                            <li>
                                <a asp-action="Index" asp-route-pagina="@(Model.PaginaAtual - 1)">
                                    <span uk-pagination-previous></span>
                                </a>
                            </li>
                        }

                        @for (int i = 1; i <= Model.TotalPaginas; i++)
                        {
                            <li class="@(i == Model.PaginaAtual ? "uk-active" : "")">
                                <a asp-action="Index" asp-route-pagina="@i">@i</a>
                            </li>
                        }

                        @if (Model.PaginaAtual < Model.TotalPaginas)
                        {
                            <li>
                                <a asp-action="Index" asp-route-pagina="@(Model.PaginaAtual + 1)">
                                    <span uk-pagination-next></span>
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            }
        }
    </div>
</div>